{{- define "main" }}

<div class="post-single">
  <header class="post-header">
    {{- partial "breadcrumbs.html" . }}
    <h1 class="post-title">{{ .Title }}</h1>
    {{- if .Description }}
    <div class="post-description">
      {{ .Description }}
    </div>
    {{- end }}
  </header>

  <div class="post-content">
    <div class="sky-eye-detail">
      <!-- 缩略图区域，点击进入全景浏览 -->
      <div class="sky-eye-thumbnail-container">
        <div class="sky-eye-thumbnail">
          <a href="{{ .RelPermalink }}view/" title="点击进入沉浸式360度查看">
            <img src="{{ .Params.thumbnail }}" alt="{{ .Title }}" loading="lazy">
            <div class="sky-eye-thumbnail-prompt">
              <div class="prompt-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>
              </div>
              <span>点击进入沉浸式360度查看</span>
            </div>
          </a>
        </div>
      </div>

      <!-- 详情信息区域 -->
      <div class="sky-eye-info">

        <!-- 拍摄时间 -->
        {{- if .Date }}
        <div class="sky-eye-info-item sky-eye-date">
          <h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            拍摄时间
          </h3>
          <p>{{ .Date.Format "2006年01月02日 15:04:05" }}</p>
        </div>
        {{- end }}

        <!-- 地点信息 -->
        {{- if .Params.location }}
        <div class="sky-eye-info-item sky-eye-location">
          <h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            拍摄地点
          </h3>
          <p>{{ .Params.location }}</p>
          {{- if .Params.coordinates }}
          <a href="https://maps.google.com/?q={{ .Params.coordinates }}" target="_blank" rel="noopener noreferrer" class="sky-eye-map-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
            在 Google Map 查看
          </a>
          {{- end }}
        </div>
        {{- end }}

        <!-- 相关文章 -->
        {{- $currentTitle := .Title }}
        {{- $relatedPosts := slice }}
        {{- range where site.RegularPages "Section" "posts" }}
          {{- if findRE $currentTitle .Content }}
            {{- $relatedPosts = $relatedPosts | append . }}
          {{- end }}
        {{- end }}

        {{- if gt (len $relatedPosts) 0 }}
        <div class="sky-eye-related-posts">
          <h3>相关文章</h3>
          <ul>
            {{- range $relatedPosts }}
            <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
            {{- end }}
          </ul>
        </div>
        {{- end }}
      </div>
    </div>
  </div>
</div>

<!-- 添加样式 -->
<style>
  .sky-eye-detail {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-top: 1rem;
  }

  .sky-eye-thumbnail-container {
    max-width: 100%;
    margin: 0 auto;
  }

  .sky-eye-thumbnail {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }

  .sky-eye-thumbnail img {
    width: 100%;
    display: block;
    transition: transform 0.5s ease;
  }

  .sky-eye-thumbnail-prompt {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: rgba(0, 0, 0, 0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px 0;
    backdrop-filter: blur(4px);
  }

  .prompt-icon {
    margin-right: 10px;
    display: flex;
    align-items: center;
  }

  .prompt-icon svg {
    color: white;
    width: 24px;
    height: 24px;
  }

  .sky-eye-thumbnail-prompt span {
    color: white;
    font-size: 1.1rem;
    font-weight: 500;
    text-align: center;
  }

  .sky-eye-thumbnail:hover img {
    transform: scale(1.03);
  }

  .sky-eye-info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background-color: var(--entry);
    border-radius: 12px;
    padding: 1.2rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  .sky-eye-info-item {
    display: flex;
    flex-direction: column;
    border-bottom: 1px solid var(--border);
    padding-bottom: 1rem;
  }

  .sky-eye-info-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .sky-eye-info h3 {
    margin-bottom: 0.7rem;
    font-size: 1.1rem;
    color: var(--primary);
    display: flex;
    align-items: center;
  }

  .sky-eye-info h3 svg {
    width: 18px;
    height: 18px;
    margin-right: 8px;
  }

  .sky-eye-info p {
    margin: 0;
    font-size: 1rem;
    line-height: 1.5;
  }

  .sky-eye-map-link {
    display: inline-flex;
    align-items: center;
    margin-top: 1rem;
    padding: 0.6rem 1.2rem;
    background-color: var(--primary);
    color: white;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .sky-eye-map-link svg {
    width: 16px;
    height: 16px;
    margin-right: 8px;
  }

  .sky-eye-map-link:hover {
    background-color: var(--secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .sky-eye-related-posts ul {
    list-style-type: none;
    padding-left: 0;
    margin: 0.5rem 0 0 0;
  }

  .sky-eye-related-posts li {
    margin-bottom: 0.7rem;
    position: relative;
    padding-left: 1.2rem;
  }

  .sky-eye-related-posts li:before {
    content: "";
    position: absolute;
    left: 0;
    top: 0.5rem;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--primary);
  }

  .sky-eye-related-posts a {
    color: var(--primary);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .sky-eye-related-posts a:hover {
    color: var(--secondary);
    text-decoration: underline;
  }

  /* 响应式设计 */
  @media (min-width: 768px) {
    .sky-eye-detail {
      flex-direction: row;
      align-items: stretch;
      min-height: 320px;
    }

    .sky-eye-thumbnail-container {
      flex: 0 0 65%;
      display: flex;
    }
    
    .sky-eye-thumbnail {
      width: 100%;
      height: 100%;
    }
    
    .sky-eye-thumbnail a {
      height: 100%;
      display: block;
    }
    
    .sky-eye-thumbnail img {
      height: 100%;
      object-fit: cover;
    }

    .sky-eye-info {
      flex: 0 0 35%;
      margin-left: 2rem;
      max-width: 400px;
      display: flex;
      flex-direction: column;
    }
  }

  @media (max-width: 767px) {
    .sky-eye-thumbnail-prompt {
      padding: 12px 0;
    }
    
    .sky-eye-thumbnail-prompt span {
      font-size: 1rem;
    }
    
    .prompt-icon svg {
      width: 20px;
      height: 20px;
    }
  }
</style>

<!-- 初始化全景照片查看器 -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 获取原始路径，去除可能的引号
    let panoramaUrl = "{{ .Params.panorama_image }}";
    const pageTitle = "{{ .Title }}";
    
    // 确保路径是绝对路径
    if (panoramaUrl && panoramaUrl.startsWith('/')) {
      panoramaUrl = window.location.origin + panoramaUrl;
    }
    
    console.log('全景照片完整路径:', panoramaUrl);

    if (!panoramaUrl) {
      console.error('未在页面元数据中找到 "panorama_image" URL。');
      document.getElementById('viewer').innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; text-align: center; color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; z-index: 1;">
          加载失败：未在页面元数据中找到 'panorama_image' URL。
        </div>`;
      return;
    }
    
    // 创建查看器实例，使用更简单的配置
    try {
      const viewer = new PhotoSphereViewer.Viewer({
        container: document.getElementById('viewer'),
        panorama: panoramaUrl,
        caption: pageTitle,
        navbar: ['zoom', 'caption', 'fullscreen'],
        defaultZoomLvl: 50,
        minFov: 30,
        maxFov: 120,
        loadingTxt: '全景照片加载中...',
        size: {
          width: '100%',
          height: '100%'
        }
      });
      
      // 添加错误事件监听器
      viewer.addEventListener('error', function(e) {
        console.error('全景照片加载失败:', e);
        document.getElementById('viewer').innerHTML = `
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; text-align: center; color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; z-index: 1;">
            <p>加载失败：${e.message}</p>
            <p>图片路径：${panoramaUrl}</p>
            <p>测试图片是否可访问：</p>
            <img src="${panoramaUrl}" style="max-width: 300px; max-height: 150px;" onerror="this.onerror=null;this.src='';this.alt='图片加载失败，路径可能错误';" />
            <p>如果上面能看到图片，说明图片路径正确，但格式可能有问题</p>
          </div>`;
      });
    } catch (error) {
      console.error('创建查看器失败:', error);
      document.getElementById('viewer').innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; text-align: center; color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; z-index: 1;">
          <p>创建查看器失败：${error.message}</p>
          <p>图片路径：${panoramaUrl}</p>
        </div>`;
    }
  });
</script>

{{- end }}{{/* end main */}}

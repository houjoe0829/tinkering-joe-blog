{{- define "main" }}
{{/* 直接定义主内容区域，不使用 PaperMod 的文章结构 */}}
<!-- Photo Sphere Viewer 依赖 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.js"></script>
<!-- 导航条插件（可选，但包含标题等） -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin/index.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin/index.min.js"></script>

<!-- 全景照片查看器容器，占满整个视口 -->
<div id="viewer" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #000;"></div>

<!-- 初始化全景照片查看器 -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 获取原始路径，去除可能的引号
    let panoramaUrl = "{{ .Params.panorama_image }}";
    const pageTitle = "{{ .Title }}";
    
    // 确保路径是绝对路径
    if (panoramaUrl && panoramaUrl.startsWith('/')) {
      panoramaUrl = window.location.origin + panoramaUrl;
    }
    
    console.log('全景照片完整路径:', panoramaUrl);

    if (!panoramaUrl) {
      console.error('未在页面元数据中找到 "panorama_image" URL。');
      document.getElementById('viewer').innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; text-align: center; color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; z-index: 1;">
          加载失败：未在页面元数据中找到 'panorama_image' URL。
        </div>`;
      return;
    }
    
    // 创建查看器实例，使用更简单的配置
    try {
      const viewer = new PhotoSphereViewer.Viewer({
        container: document.getElementById('viewer'),
        panorama: panoramaUrl,
        caption: pageTitle,
        navbar: ['zoom', 'caption', 'fullscreen'],
        defaultZoomLvl: 50,
        minFov: 30,
        maxFov: 120,
        loadingTxt: '全景照片加载中...',
        size: {
          width: '100%',
          height: '100%'
        }
      });
      
      // 添加错误事件监听器
      viewer.addEventListener('error', function(e) {
        console.error('全景照片加载失败:', e);
        document.getElementById('viewer').innerHTML = `
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; text-align: center; color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; z-index: 1;">
            <p>加载失败：${e.message}</p>
            <p>图片路径：${panoramaUrl}</p>
            <p>测试图片是否可访问：</p>
            <img src="${panoramaUrl}" style="max-width: 300px; max-height: 150px;" onerror="this.onerror=null;this.src='';this.alt='图片加载失败，路径可能错误';" />
            <p>如果上面能看到图片，说明图片路径正确，但格式可能有问题</p>
          </div>`;
      });
    } catch (error) {
      console.error('创建查看器失败:', error);
      document.getElementById('viewer').innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; text-align: center; color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; z-index: 1;">
          <p>创建查看器失败：${error.message}</p>
          <p>图片路径：${panoramaUrl}</p>
        </div>`;
    }
  });
</script>

{{- end }}{{/* end main */}}
